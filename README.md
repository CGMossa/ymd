
<!-- README.md is generated from README.Rmd. Please edit that file -->
# ymd

<!-- badges: start -->
[![R-CMD-check](https://github.com/shrektan/ymd/workflows/R-CMD-check/badge.svg)](https://github.com/shrektan/ymd/actions) [![CRAN status](https://www.r-pkg.org/badges/version/ymd)](https://CRAN.R-project.org/package=ymd) [![Downloads from the RStudio CRAN mirror](https://cranlogs.r-pkg.org/badges/ymd)](https://cran.r-project.org/package=ymd) [![Rust Code Coverage](https://coveralls.io/repos/github/shrektan/ymd/badge.svg?branch=main)](https://coveralls.io/github/shrektan/ymd?branch=main) <!-- badges: end -->

Convert 'YMD' format number or string to Date efficiently, e.g., `211225` to `as.Date("2021-12-25")`, using Rust's standard library. It also provides helper functions to handle Date, e.g., quick finding the beginning or end of the given period, adding months to Date, etc.

It's similar to the `lubridate` package but is much lighter and focuses only on Date objects.

## Installation

### Binary version (no Rust toolchain required)

The binary package is provided by CRAN. So, if you are on Windows or macOS, the package can be installed via:

``` r
install.packages("ymd")
```

If you are on Linux, you can try to use the [RSPM (RStudio Package Manager) repo](https://packagemanager.rstudio.com) provided by RStudio PBC, via (remember to choose the correct binary repo URL for your platform):

``` r
install.packages("ymd", repos = "{RSPM-Repo-URL}")
```

In addition, you may download the binary package file generated by GitHub Action from [the release page](https://github.com/shrektan/ymd/releases) and install via:

``` r
install.packages("{the-downloaded-binary-pkg-file}", repos = NULL)
```

| artifact                                   |      platform|
|:-------------------------------------------|-------------:|
| ymd\_0.0.1.tgz                             |   macOS Intel|
| ymd\_0.0.1.zip                             |       Windows|
| ymd\_0.0.1\_R\_x86\_64-pc-linux-gnu.tar.gz |  Ubuntu-18.04|

### Source version (Rust toolchain required)

If you want to build the dev version from source, you'll need the Rust toolchain, which can be installed following [the instructions from the Rust book](https://doc.rust-lang.org/book/ch01-01-installation.html).

After that, you can build the package via:

``` r
remotes::install_github("ymd")
```

## Use Cases and Benchmarks

``` r
print_bmk <- function(x) {
  x[[1]] <- format(x[[1]])
  x[[5]] <- format(x[[5]])
  rnd <- \(v) if (is.numeric(v)) round(v, 1) else v
  x[, 1:8] |> lapply(rnd) |> as.data.frame() |> knitr::kable() |> print()
}
run_bmk <- function(..., time_unit = "us") {
  bench::mark(..., time_unit = time_unit) |> print_bmk()
}
```

### ymd

``` r
x <- c("210101", "21/02/03", "89-1-03", "1989.03.05", "01 02 03")
x <- rep(x, 100)
run_bmk(
  ymd::ymd(x),
  lubridate::ymd(x)
)
```

| expression        |     min|  median|  itr.sec| mem\_alloc |  gc.sec|  n\_itr|  n\_gc|
|:------------------|-------:|-------:|--------:|:-----------|-------:|-------:|------:|
| ymd::ymd(x)       |    44.5|    45.1|  21907.6| 222.05KB   |     0.0|   10000|      0|
| lubridate::ymd(x) |  1539.3|  1580.4|    628.1| 8.21MB     |    17.5|     287|      8|

``` r

x <- c(210101, 210224, 211231, 19890103)
x <- rep(x, 100)
run_bmk(
  ymd::ymd(x),
  lubridate::ymd(x)
)
```

| expression        |     min|  median|  itr.sec| mem\_alloc |  gc.sec|  n\_itr|  n\_gc|
|:------------------|-------:|-------:|--------:|:-----------|-------:|-------:|------:|
| ymd::ymd(x)       |    11.9|    12.5|  78470.8| 3.17KB     |     0.0|   10000|      0|
| lubridate::ymd(x) |  1687.5|  1717.7|    576.1| 373.41KB   |    19.6|     265|      9|

``` r

x <- c("2021-01-01", "2022-12-31", "1995-03-22")
x <- rep(x, 100)
run_bmk(
  ymd::ymd(x),
  lubridate::ymd(x),
  as.Date(x)
)
```

| expression        |    min|  median|  itr.sec| mem\_alloc |  gc.sec|  n\_itr|  n\_gc|
|:------------------|------:|-------:|--------:|:-----------|-------:|-------:|------:|
| ymd::ymd(x)       |   32.6|    33.5|  29784.2| 2.39KB     |     0.0|   10000|      0|
| lubridate::ymd(x) |  783.3|   797.2|   1249.0| 201.1KB    |    21.8|     572|     10|
| as.Date(x)        |  660.5|   669.3|   1491.8| 87.54KB    |     0.0|     746|      0|

``` r

x <- ymd::ymd(210515) + 1:100
run_bmk(
  ymd::eop$tm(x),
  lubridate::ceiling_date(x, "month") - 1
)
```

| expression                               |   min|  median|   itr.sec| mem\_alloc |  gc.sec|  n\_itr|  n\_gc|
|:-----------------------------------------|-----:|-------:|---------:|:-----------|-------:|-------:|------:|
| ymd::eop$tm(x)                           |   5.6|     6.0|  163172.1| 19.3KB     |    16.3|    9999|      1|
| lubridate::ceiling\_date(x, "month") - 1 |  94.8|    99.3|    9980.5| 255.1KB    |    35.4|    4508|     16|

### edate

``` r
`%m+%` <- lubridate::`%m+%`
x <- ymd::ymd(c(200115, 200131, 200229, 200331, 200401))
x <- rep(x, 100)
run_bmk(
  ymd::edate(x, 2),
  x %m+% months(2)
)
```

| expression       |    min|  median|  itr.sec| mem\_alloc |  gc.sec|  n\_itr|  n\_gc|
|:-----------------|------:|-------:|--------:|:-----------|-------:|-------:|------:|
| ymd::edate(x, 2) |   13.3|    14.1|  70085.1| 6.2KB      |     0.0|   10000|      0|
| x %m+% months(2) |  295.1|   308.6|   3225.2| 424.6KB    |    23.6|    1505|     11|

``` r
run_bmk(
  ymd::edate(x, -12),
  x %m+% months(-12)
)
```

| expression         |    min|  median|  itr.sec| mem\_alloc |  gc.sec|  n\_itr|  n\_gc|
|:-------------------|------:|-------:|--------:|:-----------|-------:|-------:|------:|
| ymd::edate(x, -12) |   13.4|    14.1|  69800.5| 3.95KB     |       7|    9999|      1|
| x %m+% months(-12) |  791.4|   821.8|   1211.8| 317.19KB   |      35|     519|     15|

### date part

``` r
# tweak from https://github.com/Rdatatable/data.table/pull/5300
set.seed(373L)
x = data.table::as.IDate(sample(seq(-25000, 45000), 1e7, TRUE))
run_bmk(
  data.table::wday(x),
  lubridate::wday(x),
  {
    out <- ymd::wday(x)
    data.table::fifelse(out == 7L, 1L, out + 1L)
  }
)
#> Warning: Some expressions had a GC in every iteration; so filtering is disabled.
```

| expression                                                            |       min|    median|  itr.sec| mem\_alloc |  gc.sec|  n\_itr|  n\_gc|
|:----------------------------------------------------------------------|---------:|---------:|--------:|:-----------|-------:|-------:|------:|
| data.table::wday(x)                                                   |   95238.8|   96371.9|     10.3| 38.2MB     |     0.0|       6|      0|
| lubridate::wday(x)                                                    |  887111.1|  887111.1|      1.1| 534.1MB    |     3.4|       1|      3|
| { out \<- ymd::wday(x) data.table::fifelse(out == 7L, 1L, out + 1L) } |  153416.4|  154006.5|      6.0| 152.6MB    |     4.0|       3|      2|

``` r

run_bmk(
  data.table::mday(x),
  lubridate::mday(x),
  ymd::mday(x)
)
#> Warning: Some expressions had a GC in every iteration; so filtering is disabled.
```

| expression          |       min|    median|  itr.sec| mem\_alloc |  gc.sec|  n\_itr|  n\_gc|
|:--------------------|---------:|---------:|--------:|:-----------|-------:|-------:|------:|
| data.table::mday(x) |  857317.2|  857317.2|      1.2| 457.8MB    |     2.3|       1|      2|
| lubridate::mday(x)  |  851888.5|  851888.5|      1.2| 457.8MB    |     1.2|       1|      1|
| ymd::mday(x)        |   89616.0|   92221.8|     10.7| 38.1MB     |     1.8|       6|      1|

``` r

run_bmk(
  data.table::isoweek(x |> head(1e6)),
  lubridate::isoweek(x |> head(1e6)),
  ymd::iso_week(x |> head(1e6))
)
```

| expression                          |        min|     median|  itr.sec| mem\_alloc |  gc.sec|  n\_itr|  n\_gc|
|:------------------------------------|----------:|----------:|--------:|:-----------|-------:|-------:|------:|
| data.table::isoweek(head(x, 1e+06)) |  2769758.1|  2769758.1|      0.4| 244.2MB    |     0.0|       1|      0|
| lubridate::isoweek(head(x, 1e+06))  |   248294.3|   248294.3|      4.0| 267MB      |     4.0|       1|      1|
| ymd::iso\_week(head(x, 1e+06))      |    12067.7|    12873.1|     76.5| 15.3MB     |     4.5|      34|      2|

``` r

run_bmk(
  data.table::month(x),
  lubridate::month(x),
  ymd::month(x)
)
#> Warning: Some expressions had a GC in every iteration; so filtering is disabled.
```

| expression           |        min|     median|  itr.sec| mem\_alloc |  gc.sec|  n\_itr|  n\_gc|
|:---------------------|----------:|----------:|--------:|:-----------|-------:|-------:|------:|
| data.table::month(x) |   894589.9|   894589.9|      1.1| 495.9MB    |     3.4|       1|      3|
| lubridate::month(x)  |  1106911.7|  1106911.7|      0.9| 915.5MB    |     1.8|       1|      2|
| ymd::month(x)        |    89589.3|    90878.0|     10.8| 38.1MB     |     1.8|       6|      1|

``` r

run_bmk(
  data.table::quarter(x),
  lubridate::quarter(x),
  ymd::quarter(x)
)
#> Warning: Some expressions had a GC in every iteration; so filtering is disabled.
```

| expression             |        min|     median|  itr.sec| mem\_alloc |  gc.sec|  n\_itr|  n\_gc|
|:-----------------------|----------:|----------:|--------:|:-----------|-------:|-------:|------:|
| data.table::quarter(x) |   897407.4|   897407.4|      1.1| 495.91MB   |     2.2|       1|      2|
| lubridate::quarter(x)  |  1258877.0|  1258877.0|      0.8| 1.04GB     |     3.2|       1|      4|
| ymd::quarter(x)        |   156128.2|   157196.5|      6.3| 38.15MB    |     1.6|       4|      1|

``` r

run_bmk(
  data.table::year(x),
  lubridate::year(x),
  funchir::quick_year(x),
  ymd::year(x)
)
#> Warning: Some expressions had a GC in every iteration; so filtering is disabled.
```

| expression              |       min|    median|  itr.sec| mem\_alloc |  gc.sec|  n\_itr|  n\_gc|
|:------------------------|---------:|---------:|--------:|:-----------|-------:|-------:|------:|
| data.table::year(x)     |  884364.2|  884364.2|      1.1| 495.9MB    |     2.3|       1|      2|
| lubridate::year(x)      |  875144.4|  875144.4|      1.1| 534.1MB    |     2.3|       1|      2|
| funchir::quick\_year(x) |  274463.3|  274903.8|      3.6| 228.9MB    |     3.6|       2|      2|
| ymd::year(x)            |   85453.5|   87009.3|     10.8| 38.1MB     |     1.8|       6|      1|

``` r

run_bmk(
  data.table::mday(x),
  lubridate::mday(x),
  funchir::quick_mday(x),
  ymd::mday(x)
)
#> Warning: Some expressions had a GC in every iteration; so filtering is disabled.
```

| expression              |       min|    median|  itr.sec| mem\_alloc |  gc.sec|  n\_itr|  n\_gc|
|:------------------------|---------:|---------:|--------:|:-----------|-------:|-------:|------:|
| data.table::mday(x)     |  853294.2|  853294.2|      1.2| 457.8MB    |     2.3|       1|      2|
| lubridate::mday(x)      |  876373.8|  876373.8|      1.1| 457.8MB    |     1.1|       1|      1|
| funchir::quick\_mday(x) |   90699.3|   92346.0|     10.8| 76.3MB     |     1.8|       6|      1|
| ymd::mday(x)            |   90981.6|   93310.3|     10.7| 38.1MB     |     1.8|       6|      1|

``` r

run_bmk(
  data.table::yday(x),
  lubridate::yday(x),
  funchir::quick_yday(x),
  ymd::yday(x)
)
#> Warning: Some expressions had a GC in every iteration; so filtering is disabled.
```

| expression              |       min|    median|  itr.sec| mem\_alloc |  gc.sec|  n\_itr|  n\_gc|
|:------------------------|---------:|---------:|--------:|:-----------|-------:|-------:|------:|
| data.table::yday(x)     |  855013.3|  855013.3|      1.2| 495.9MB    |     1.2|       1|      1|
| lubridate::yday(x)      |  851648.0|  851648.0|      1.2| 534.1MB    |     2.3|       1|      2|
| funchir::quick\_yday(x) |  221956.5|  224673.2|      4.3| 190.7MB    |     4.3|       3|      3|
| ymd::yday(x)            |   85971.1|   87490.4|     11.4| 38.1MB     |     0.0|       6|      0|
